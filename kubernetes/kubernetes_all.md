# Commands - Initializing

### Create Kubernetes Repository

```
curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add -
```
```
cat <<EOF > /etc/apt/sources.list.d/kubernetes.list
deb http://apt.kubernetes.io/ kubernetes-xenial main
EOF
```

### [FYI only] k8s user data script 

[kubernetes user data script · GitHub](https://gist.github.com/initcron/40b71211cb693f541ce35fe3fb1adb11)

```
#!/bin/bash 

apt-get update
apt-get install -y git wget

# Install Docker
apt-get install \
    apt-transport-https \
    ca-certificates \
    curl \
    software-properties-common

curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
apt-key fingerprint 0EBFCD88
add-apt-repository \
   "deb [arch=amd64] https://download.docker.com/linux/ubuntu \
   $(lsb_release -cs) \
   stable"
   
apt-get update

apt-get install -yq docker-ce



curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -

sudo cat <<EOF > /etc/apt/sources.list.d/kubernetes.list
deb http://apt.kubernetes.io/ kubernetes-xenial main
EOF

sudo apt-get update -y

sudo apt-get install -y  kubelet kubeadm kubectl kubernetes-cni nfs-common

sudo sysctl net.bridge.bridge-nf-call-iptables=1
sudo swapoff -a

sudo rm -rf /var/lib/kubelet/*

sudo apt-get install nfs-common -y
```

### To initialize a master node in k8s

Once run the below starts advertising master node with the IP provided. 
```
kubeadm init --apiserver-advertise-address 192.168.12.10 --pod-network-cidr=192.168.0.0/16
```
Sample output to a successful run. (Setting up KubeCtl)
```
Your Kubernetes master has initialized successfully!

To start using your cluster, you need to run the following as a regular user:

  mkdir -p $HOME/.kube
  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
  sudo chown $(id -u):$(id -g) $HOME/.kube/config

You should now deploy a pod network to the cluster.
Run "kubectl apply -f [podnetwork].yaml" with one of the options listed at:
  https://kubernetes.io/docs/concepts/cluster-administration/addons/

You can now join any number of machines by running the following on each node
as root:

  kubeadm join 192.168.12.10:6443 --token 49h7j5.kaz8nwl1oyjev8aw --discovery-token-ca-cert-hash sha256:6eedec0048c0d9fd997b6b07bc01923ba9204a1d4ed1bbc20bccff518966a1ce
```
### Example of running the join string with token on of the nodes 
```
root@kube-02:~# kubeadm join 192.168.12.10:6443 --token 49h7j5.kaz8nwl1oyjev8aw --discovery-token-ca-cert-hash sha256:6eedec0048c0d9fd997b6b07bc01923ba9204a1d4ed1bbc20bccff518966a1ce
[preflight] Running pre-flight checks.
	[WARNING FileExisting-crictl]: crictl not found in system path
Suggestion: go get github.com/kubernetes-incubator/cri-tools/cmd/crictl
[discovery] Trying to connect to API Server "192.168.12.10:6443"
[discovery] Created cluster-info discovery client, requesting info from "https://192.168.12.10:6443"
[discovery] Requesting info from "https://192.168.12.10:6443" again to validate TLS against the pinned public key
[discovery] Cluster info signature and contents are valid and TLS certificate validates against pinned roots, will use API Server "192.168.12.10:6443"
[discovery] Successfully established connection with API Server "192.168.12.10:6443"

This node has joined the cluster:
* Certificate signing request was sent to master and a response
  was received.
* The Kubelet was informed of the new secure connection details.

Run 'kubectl get nodes' on the master to see this node join the cluster.
root@kube-02:~#
```

### Get Worker Nodes from master: 

```
root@kube-01:~# kubectl get nodes
NAME      STATUS     ROLES     AGE       VERSION
kube-01   NotReady   master    21h       v1.10.3
kube-02   NotReady   <none>    21h       v1.10.3
kube-03   NotReady   <none>    21h       v1.10.3
root@kube-01:~#
```

```
root@kube-01:~# kubectl get nodes -o wide
NAME      STATUS     ROLES     AGE       VERSION   EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION      CONTAINER-RUNTIME
kube-01   NotReady   master    22h       v1.10.3   <none>        Ubuntu 16.04.4 LTS   4.4.0-127-generic   docker://1.13.1
kube-02   NotReady   <none>    21h       v1.10.3   <none>        Ubuntu 16.04.4 LTS   4.4.0-127-generic   docker://1.13.1
kube-03   NotReady   <none>    21h       v1.10.3   <none>        Ubuntu 16.04.4 LTS   4.4.0-127-generic   docker://1.13.1
root@kube-01:~#
```
Adding watch to make it real time:
```
watch -n 1 kubectl get nodes -o wide
```

### Other handy Kubeadm commands:

```
root@kube-01:~# kubeadm token list
TOKEN                     TTL       EXPIRES                USAGES                   DESCRIPTION                                                EXTRA GROUPS
49h7j5.kaz8nwl1oyjev8aw   1h        2018-05-30T08:40:35Z   authentication,signing   The default bootstrap token generated by 'kubeadm init'.   system:bootstrappers:kubeadm:default-node-token
```
```
root@kube-01:~# kubeadm

kubeadm: easily bootstrap a secure Kubernetes cluster.

    ┌──────────────────────────────────────────────────────────┐
    │ KUBEADM IS CURRENTLY IN BETA                             │
    │                                                          │
    │ But please, try it out and give us feedback at:          │
    │ https://github.com/kubernetes/kubeadm/issues             │
    │ and at-mention @kubernetes/sig-cluster-lifecycle-bugs    │
    │ or @kubernetes/sig-cluster-lifecycle-feature-requests    │
    └──────────────────────────────────────────────────────────┘

Example usage:

    Create a two-machine cluster with one master (which controls the cluster),
    and one node (where your workloads, like Pods and Deployments run).

    ┌──────────────────────────────────────────────────────────┐
    │ On the first machine:                                    │
    ├──────────────────────────────────────────────────────────┤
    │ master# kubeadm init                                     │
    └──────────────────────────────────────────────────────────┘

    ┌──────────────────────────────────────────────────────────┐
    │ On the second machine:                                   │
    ├──────────────────────────────────────────────────────────┤
    │ node# kubeadm join <arguments-returned-from-init>        │
    └──────────────────────────────────────────────────────────┘

    You can then repeat the second step on as many other machines as you like.

Usage:
  kubeadm [command]

Available Commands:
  alpha       Experimental sub-commands not yet fully functional.
  completion  Output shell completion code for the specified shell (bash or zsh).
  config      Manage configuration for a kubeadm cluster persisted in a ConfigMap in the cluster.
  help        Help about any command
  init        Run this command in order to set up the Kubernetes master.
  join        Run this on any machine you wish to join an existing cluster
  reset       Run this to revert any changes made to this host by 'kubeadm init' or 'kubeadm join'.
  token       Manage bootstrap tokens.
  upgrade     Upgrade your cluster smoothly to a newer version with this command.
  version     Print the version of kubeadm

Flags:
  -h, --help   help for kubeadm

Use "kubeadm [command] --help" for more information about a command.
root@kube-01:~#
```

### Setup the admin client - Kubectl

On Master Node

```
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
```

### Installing CNI with Weave (Network)

Installing overlay network is necessary for the pods to communicate with each other across the hosts. It is necessary to do this before you try to deploy any applications to your cluster.

There are various overlay networking drivers available for kubernetes.

```
export kubever=$(kubectl version | base64 | tr -d '\n')
kubectl apply -f "https://cloud.weave.works/k8s/net?k8s-version=$kubever"
```

### To check the cluster info
```
root@kube-01:~# kubectl cluster-info
Kubernetes master is running at https://192.168.12.10:6443
KubeDNS is running at https://192.168.12.10:6443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy

To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.
root@kube-01:~#
```

### Additional KubeCTL Commands: 
To get the version
```
kubectl version
```
To get component status
```
root@kube-01:~# kubectl get cs
NAME                 STATUS    MESSAGE              ERROR
scheduler            Healthy   ok
controller-manager   Healthy   ok
etcd-0               Healthy   {"health": "true"}
root@kube-01:~#
```

### To get pod details with kubectl. 
```
root@kube-01:~# kubectl get pods --all-namespaces
NAMESPACE     NAME                              READY     STATUS    RESTARTS   AGE
kube-system   etcd-kube-01                      1/1       Running   0          22h
kube-system   kube-apiserver-kube-01            1/1       Running   0          22h
kube-system   kube-controller-manager-kube-01   1/1       Running   0          22h
kube-system   kube-dns-86f4d74b45-54bt7         3/3       Running   0          22h
kube-system   kube-proxy-8rrw7                  1/1       Running   0          22h
kube-system   kube-proxy-jjddb                  1/1       Running   0          22h
kube-system   kube-proxy-qmz6x                  1/1       Running   0          22h
kube-system   kube-scheduler-kube-01            1/1       Running   0          22h
kube-system   weave-net-gntpx                   2/2       Running   0          5m
kube-system   weave-net-qpjkv                   2/2       Running   0          5m
kube-system   weave-net-vhntx                   2/2       Running   0          5m
```
### Getting to know the events in a cluster. 
```
root@kube-01:~# kubectl get events
LAST SEEN   FIRST SEEN   COUNT     NAME                       KIND      SUBOBJECT   TYPE      REASON      SOURCE             MESSAGE
15m         15m          1         kube-01.15335a352cd642db   Node                  Normal    NodeReady   kubelet, kube-01   Node kube-01 status is now: NodeReady
15m         15m          1         kube-02.15335a3577ea915e   Node                  Normal    NodeReady   kubelet, kube-02   Node kube-02 status is now: NodeReady
15m         15m          1         kube-03.15335a3293677593   Node                  Normal    NodeReady   kubelet, kube-03   Node kube-03 status is now: NodeReady
root@kube-01:~#
```

### Enable Kubernetes Dashboard.
```
kubectl apply -f https://gist.githubusercontent.com/initcron/32ff89394c881414ea7ef7f4d3a1d499/raw/4863613585d05f9360321c7141cc32b8aa305605/kube-dashboard.yaml
```
This will create a pod for the Kubernetes Dashboard.

To access the Dashboard in th browser, run the below command

```
kubectl describe svc kubernetes-dashboard -n kube-system
```

Output Below:

```
root@kube-01:~# kubectl describe svc kubernetes-dashboard -n kube-system
Name:                     kubernetes-dashboard
Namespace:                kube-system
Labels:                   k8s-app=kubernetes-dashboard
Annotations:              kubectl.kubernetes.io/last-applied-configuration={"apiVersion":"v1","kind":"Service","metadata":{"annotations":{},"labels":{"k8s-app":"kubernetes-dashboard"},"name":"kubernetes-dashboard","namespace":...
Selector:                 k8s-app=kubernetes-dashboard
Type:                     NodePort
IP:                       10.96.185.156
Port:                     <unset>  80/TCP
TargetPort:               9090/TCP
NodePort:                 <unset>  31000/TCP
Endpoints:                10.32.0.3:9090
Session Affinity:         None
External Traffic Policy:  Cluster
Events:                   <none>
root@kube-01:~#
```

### Watch command to monitor: 
```
watch -n 1 kubectl get pods,deploy,svc --all-namespaces -o wide
```
```
Every 1.0s: kubectl get pods,deploy,svc --all-namespaces -o wide                                                                                                                                                                                      Wed May 30 09:45:44 2018

NAMESPACE     NAME                                        READY     STATUS    RESTARTS   AGE       IP              NODE
kube-system   pod/etcd-kube-01                            1/1       Running   1          1d        192.168.12.10   kube-01
kube-system   pod/kube-apiserver-kube-01                  1/1       Running   1          1d        192.168.12.10   kube-01
kube-system   pod/kube-controller-manager-kube-01         1/1       Running   1          1d        192.168.12.10   kube-01
kube-system   pod/kube-dns-86f4d74b45-54bt7               3/3       Running   3          1d        10.32.0.5       kube-03
kube-system   pod/kube-proxy-8rrw7                        1/1       Running   1          1d        192.168.12.12   kube-03
kube-system   pod/kube-proxy-jjddb                        1/1       Running   1          1d        192.168.12.10   kube-01
kube-system   pod/kube-proxy-qmz6x                        1/1       Running   1          1d        192.168.12.11   kube-02
kube-system   pod/kube-scheduler-kube-01                  1/1       Running   1          1d        192.168.12.10   kube-01
kube-system   pod/kubernetes-dashboard-75d647ffd9-mgbff   1/1       Running   1          1h        10.32.0.4       kube-03
kube-system   pod/weave-net-gntpx                         2/2       Running   3          2h        192.168.12.10   kube-01
kube-system   pod/weave-net-qpjkv                         2/2       Running   3          2h        192.168.12.12   kube-03
kube-system   pod/weave-net-vhntx                         2/2       Running   3          2h        192.168.12.11   kube-02

NAMESPACE     NAME                                         DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE       CONTAINERS                IMAGES                                                                                                                           S
ELECTOR
kube-system   deployment.extensions/kube-dns               1         1         1            1           1d        kubedns,dnsmasq,sidecar   k8s.gcr.io/k8s-dns-kube-dns-amd64:1.14.8,k8s.gcr.io/k8s-dns-dnsmasq-nanny-amd64:1.14.8,k8s.gcr.io/k8s-dns-sidecar-amd64:1.14.8   k
8s-app=kube-dns
kube-system   deployment.extensions/kubernetes-dashboard   1         1         1            1           1h        kubernetes-dashboard      gcr.io/google_containers/kubernetes-dashboard-amd64:v1.6.3                                                                       k
8s-app=kubernetes-dashboard

NAMESPACE     NAME                           TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)         AGE       SELECTOR
default       service/kubernetes             ClusterIP   10.96.0.1       <none>        443/TCP         1d        <none>
kube-system   service/kube-dns               ClusterIP   10.96.0.10      <none>        53/UDP,53/TCP   1d        k8s-app=kube-dns
kube-system   service/kubernetes-dashboard   NodePort    10.96.185.156   <none>        80:31000/TCP    1h        k8s-app=kubernetes-dashboard
```

#### To describe a service: 

```
root@kube-01:~# kubectl describe svc kubernetes-dashboard -n kube-system
Name:                     kubernetes-dashboard
Namespace:                kube-system
Labels:                   k8s-app=kubernetes-dashboard
Annotations:              kubectl.kubernetes.io/last-applied-configuration={"apiVersion":"v1","kind":"Service","metadata":{"annotations":{},"labels":{"k8s-app":"kubernetes-dashboard"},"name":"kubernetes-dashboard","namespace":...
Selector:                 k8s-app=kubernetes-dashboard
Type:                     NodePort
IP:                       10.96.185.156
Port:                     <unset>  80/TCP
TargetPort:               9090/TCP
NodePort:                 <unset>  31000/TCP
Endpoints:                10.32.0.4:9090
Session Affinity:         None
External Traffic Policy:  Cluster
Events:                   <none>
root@kube-01:~#
```




